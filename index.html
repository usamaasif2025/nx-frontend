<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stock Chart Viewer</title>

    <style>
      body { font-family: Arial, sans-serif; padding: 20px; background: #fafafa; }
      input, select { padding: 10px; font-size: 16px; }
      button { padding: 10px 14px; font-size: 16px; cursor: pointer; background: #1e88e5; color: white; border: none; border-radius: 4px; }
      button:hover { background: #1565c0; }
      .toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 16px; }
      .card { margin-top: 16px; padding: 14px; border: 1px solid #ddd; border-radius: 10px; background: #fff; box-shadow: 0 0 8px rgba(0,0,0,0.05); }
      .muted { color: #666; font-size: 13px; }
      #chart { width: 100%; height: 450px; }
    </style>
  </head>

  <body>
    <h2>ðŸ“Š Stock Candlestick Chart Viewer</h2>

    <div class="toolbar">
      <input id="ticker" placeholder="Enter ticker symbol (e.g. TSLA)" />
      <button id="btn">Show Chart</button>
      <label for="timeframe">Timeframe:</label>
      <select id="timeframe">
        <option value="1mo">1 Month</option>
        <option value="1w">1 Week</option>
        <option value="1d" selected>1 Day</option>
        <option value="1h">1 Hour</option>
        <option value="1m">1 Minute</option>
        <option value="15s">15 Seconds</option>
      </select>
    </div>

    <div id="chart-card" class="card" style="display:none;">
      <div id="chart"></div>
      <div id="chart-meta" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- Lightweight Charts (TradingView library) -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script>
      const tickerEl = document.getElementById("ticker");
      const btn = document.getElementById("btn");
      const timeframeEl = document.getElementById("timeframe");
      const chartEl = document.getElementById("chart");
      const chartCardEl = document.getElementById("chart-card");
      const chartMetaEl = document.getElementById("chart-meta");

      let chart;
      let candleSeries;
      let lastTicker = "";

      // Initialize chart structure
      function ensureChart() {
        if (!chart) {
          chart = LightweightCharts.createChart(chartEl, {
            layout: { background: { color: "#fff" }, textColor: "#111" },
            grid: { vertLines: { color: "#f2f2f2" }, horzLines: { color: "#f2f2f2" } },
            rightPriceScale: { borderColor: "#ccc" },
            timeScale: { borderColor: "#ccc", timeVisible: true, secondsVisible: true },
          });

          const resize = () => chart.applyOptions({ width: chartEl.clientWidth });
          window.addEventListener("resize", resize);
          resize();
        }

        if (!candleSeries) {
          candleSeries = chart.addCandlestickSeries({
            upColor: "#26a69a",
            downColor: "#ef5350",
            wickUpColor: "#26a69a",
            wickDownColor: "#ef5350",
            borderVisible: false,
          });
        }
      }

      // Fetch candle data and draw chart
      async function loadCandles(ticker) {
        const timeframe = timeframeEl.value;
        const r = await fetch(`/api/candles?ticker=${encodeURIComponent(ticker)}&timeframe=${encodeURIComponent(timeframe)}`);
        const data = await r.json();

        if (!r.ok) throw new Error(data.error || "Failed to load candle data");

        ensureChart();
        candleSeries.setData(data.candles);
        chart.timeScale().fitContent();

        chartMetaEl.textContent =
          `Showing ${data.timeframe.toUpperCase()} candles for ${ticker.toUpperCase()} (${new Date(data.from * 1000).toLocaleDateString()} - ${new Date(data.to * 1000).toLocaleDateString()})`;
        chartCardEl.style.display = "block";
      }

      // Event when clicking 'Show Chart'
      btn.addEventListener("click", async () => {
        const t = tickerEl.value.trim().toUpperCase();
        if (!t) return alert("Please enter a ticker symbol.");

        try {
          await loadCandles(t);
          lastTicker = t;
        } catch (err) {
          chartMetaEl.textContent = `Error: ${err.message || err}`;
          chartCardEl.style.display = "block";
        }
      });

      // Auto-refresh chart when timeframe changes
      timeframeEl.addEventListener("change", async () => {
        if (!lastTicker) return;
        try {
          await loadCandles(lastTicker);
        } catch (err) {
          chartMetaEl.textContent = `Error: ${err.message || err}`;
        }
      });
    </script>
  </body>
</html>

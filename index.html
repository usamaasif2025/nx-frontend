<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Phase 1 Ticker</title>
    <style>
      body { font-family: Arial, sans-serif; padding: 20px; }
      input, select { padding: 10px; font-size: 16px; }
      button { padding: 10px 14px; font-size: 16px; cursor: pointer; }
      .toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
      .card { margin-top: 16px; padding: 14px; border: 1px solid #ddd; border-radius: 10px; }
      .yes { color: #0a7a0a; font-weight: bold; }
      .no { color: #b00020; font-weight: bold; }
      .muted { color: #666; font-size: 13px; }
      pre { background: #f6f6f6; padding: 10px; border-radius: 8px; overflow: auto; }
      #chart-card { margin-top: 16px; }
      #chart { width: 100%; height: 420px; }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <input id="ticker" placeholder="TSLA" />
      <button id="btn">Check</button>
      <label for="timeframe">Timeframe:</label>
      <select id="timeframe">
        <option value="10s">10 sec</option>
        <option value="1m">1 min</option>
        <option value="1h">1 hour</option>
        <option value="1d" selected>1 day</option>
        <option value="1w">1 week</option>
        <option value="1mo">1 month</option>
      </select>
    </div>

    <div id="result" class="card" style="display:none;"></div>
    <div id="chart-card" class="card" style="display:none;">
      <div id="chart"></div>
      <div id="chart-meta" class="muted" style="margin-top:8px;"></div>
    </div>
    <pre id="raw" style="display:none;"></pre>

    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script>
      const tickerEl = document.getElementById("ticker");
      const btn = document.getElementById("btn");
      const timeframeEl = document.getElementById("timeframe");
      const resultEl = document.getElementById("result");
      const rawEl = document.getElementById("raw");
      const chartCardEl = document.getElementById("chart-card");
      const chartMetaEl = document.getElementById("chart-meta");
      const chartEl = document.getElementById("chart");

      let chart;
      let candleSeries;
      let lastTicker = "";

      function createCandlestickSeries() {
        if (typeof chart.addCandlestickSeries === "function") {
          return chart.addCandlestickSeries({
            upColor: "#26a69a",
            downColor: "#ef5350",
            borderVisible: false,
            wickUpColor: "#26a69a",
            wickDownColor: "#ef5350",
          });
        }

        if (typeof chart.addSeries === "function" && LightweightCharts.CandlestickSeries) {
          return chart.addSeries(LightweightCharts.CandlestickSeries, {
            upColor: "#26a69a",
            downColor: "#ef5350",
            borderVisible: false,
            wickUpColor: "#26a69a",
            wickDownColor: "#ef5350",
          });
        }

        throw new Error("Unsupported Lightweight Charts API version");
      }

      function ensureChart() {
        if (!chart) {
          chart = LightweightCharts.createChart(chartEl, {
            layout: { background: { color: "#ffffff" }, textColor: "#222" },
            grid: { vertLines: { color: "#f0f0f0" }, horzLines: { color: "#f0f0f0" } },
            rightPriceScale: { borderColor: "#ddd" },
            timeScale: { borderColor: "#ddd", timeVisible: true, secondsVisible: true },
          });

          const resize = () => {
            chart.applyOptions({ width: chartEl.clientWidth || 900 });
          };
          window.addEventListener("resize", resize);
          resize();
        }

        if (!candleSeries) {
          candleSeries = createCandlestickSeries();
        }
      }

      function fmtPct(x) {
        return (x * 100).toFixed(2) + "%";
      }

      async function loadCandles(ticker) {
        const timeframe = timeframeEl.value;
        const r = await fetch(
          `/api/candles?ticker=${encodeURIComponent(ticker)}&timeframe=${encodeURIComponent(timeframe)}`
        );
        const data = await r.json();

        if (!r.ok) {
          throw new Error(data.error || "Failed to load candle data");
        }

        ensureChart();
        candleSeries.setData(data.candles);
        chart.timeScale().fitContent();

        const fallbackNote = data.fallbackApplied
          ? "10 sec is not available from provider; showing 1-minute candles."
          : "";

        chartMetaEl.textContent = `Showing ${data.timeframe} candles for ~2 years (${new Date(
          data.from * 1000
        ).toLocaleDateString()} - ${new Date(data.to * 1000).toLocaleDateString()}). ${fallbackNote}`.trim();
        chartCardEl.style.display = "block";
      }

      timeframeEl.addEventListener("change", async () => {
        if (!lastTicker) return;
        try {
          await loadCandles(lastTicker);
        } catch (e) {
          chartMetaEl.textContent = `Chart error: ${e.message || e}`;
        }
      });

      btn.addEventListener("click", async () => {
        const t = tickerEl.value.trim().toUpperCase();
        resultEl.style.display = "none";
        rawEl.style.display = "none";
        chartCardEl.style.display = "none";
        resultEl.innerHTML = "Loading...";

        if (!t) return;

        try {
          const r = await fetch(`/api/check?ticker=${encodeURIComponent(t)}`);
          const data = await r.json();

          if (!r.ok) {
            resultEl.style.display = "block";
            resultEl.innerHTML = `<strong>Error:</strong> ${data.error || "Unknown error"}`;
            return;
          }

          const statusClass = data.meetsRule ? "yes" : "no";
          const statusText = data.meetsRule ? "YES" : "NO";

          resultEl.style.display = "block";
          resultEl.innerHTML = `
            <div><strong>${data.ticker}</strong> — <span class="${statusClass}">${statusText}</span> (≥ ${(data.threshold * 100).toFixed(0)}%)</div>
            <div>Current: <strong>$${data.current}</strong></div>
            <div>Prev Close: $${data.prevClose}</div>
            <div>% Change: ${fmtPct(data.pctChange)}</div>
            <div>Open: $${data.open} | High: $${data.high} | Low: $${data.low}</div>
            <div>Time: ${data.timestamp || "N/A"}</div>
          `;

          lastTicker = data.ticker;
          await loadCandles(lastTicker);

          rawEl.style.display = "block";
          rawEl.textContent = JSON.stringify(data, null, 2);
        } catch (e) {
          resultEl.style.display = "block";
          resultEl.innerHTML = `<strong>Error:</strong> ${e}`;
        }
      });
    </script>
  </body>
</html>
